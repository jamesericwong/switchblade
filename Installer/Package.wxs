<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs" xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
  <Package Name="SwitchBlade" Manufacturer="James Wong" Version="1.4.12" UpgradeCode="a3543202-6014-486c-a964-15967d6f8c44" Scope="perUserOrMachine">
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." AllowSameVersionUpgrades="yes" />

    <Property Id="WixAppFolder" Value="WixPerUserFolder" />
    <WixVariable Id="WixUISupportPerUser" Value="1" />
    <WixVariable Id="WixUISupportPerMachine" Value="1" />
    
    <MediaTemplate EmbedCab="yes" />

    <!-- Use ProgramFiles64Folder for x64 -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="SwitchBlade" />
    </StandardDirectory>

    <StandardDirectory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="SwitchBlade" />
    </StandardDirectory>

    <Feature Id="Main">
      <ComponentGroupRef Id="AppComponents" />
      <ComponentRef Id="ApplicationShortcut" />
      <ComponentRef Id="RegistryPersistence" />
    </Feature>
    
    <!-- Startup Feature - installed when LAUNCHONSTARTUP is set (checked) -->
    <Feature Id="StartupFeature" Level="2" Title="Windows Startup" Description="Start SwitchBlade when Windows starts">
      <ComponentRef Id="StartupRegistryEntry" />
    </Feature>
    
    <!-- UI Configuration -->
    <ui:WixUI Id="WixUI_InstallDir" InstallDirectory="INSTALLFOLDER" />
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
    <WixVariable Id="WixUIDialogBmp" Value="Background.bmp" />
    <WixVariable Id="WixUIBannerBmp" Value="Banner.bmp" />
    
    <!-- Launch on Exit Logic -->
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch SwitchBlade" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1" />
    
    <!-- Use standard MSI action to launch installed file -->
    <!-- Property WixShellExecTarget is set via Publish on ExitDialog to avoid WIX1077 warning -->
    <CustomAction Id="LaunchApplication" BinaryRef="Wix4UtilCA_X86" DllEntry="WixShellExec" Impersonate="yes" />

    <UI>
        <!-- Welcome -> License (Standard) -->
        
        <!-- License -> InstallScope -->
        <Publish Dialog="LicenseAgreementDlg" Control="Next" Event="NewDialog" Value="InstallScopeDlg" Order="2" Condition="LicenseAccepted = &quot;1&quot;" />
        
        <!-- InstallScope -> License (Back) -->
        <Publish Dialog="InstallScopeDlg" Control="Back" Event="NewDialog" Value="LicenseAgreementDlg" Order="1" />
        
        <!-- InstallScope -> InstallDir (Next) -->
        <!-- Logic: If WixAppFolder is WixPerUserFolder (Per User) -->
        <Publish Dialog="InstallScopeDlg" Control="Next" Property="MSIINSTALLPERUSER" Value="1" Order="1" Condition="WixAppFolder = &quot;WixPerUserFolder&quot;" />
        <Publish Dialog="InstallScopeDlg" Control="Next" Property="ALLUSERS" Value="2" Order="2" Condition="WixAppFolder = &quot;WixPerUserFolder&quot;" />
        <Publish Dialog="InstallScopeDlg" Control="Next" Property="INSTALLFOLDER" Value="[LocalAppDataFolder]Programs\SwitchBlade" Order="3" Condition="WixAppFolder = &quot;WixPerUserFolder&quot;" />
        
        <!-- Logic: If WixAppFolder is WixPerMachineFolder (Per Machine) -->
        <Publish Dialog="InstallScopeDlg" Control="Next" Property="MSIINSTALLPERUSER" Value="{}" Order="4" Condition="WixAppFolder = &quot;WixPerMachineFolder&quot;" />
        <Publish Dialog="InstallScopeDlg" Control="Next" Property="ALLUSERS" Value="1" Order="5" Condition="WixAppFolder = &quot;WixPerMachineFolder&quot;" />
        <Publish Dialog="InstallScopeDlg" Control="Next" Property="INSTALLFOLDER" Value="[ProgramFiles64Folder]SwitchBlade" Order="6" Condition="WixAppFolder = &quot;WixPerMachineFolder&quot;" />
        
        <Publish Dialog="InstallScopeDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg" Order="7" />
        
        <!-- InstallDir -> InstallScope (Back) -->
        <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="InstallScopeDlg" Order="2" Condition="NOT Installed" />

        <!-- Wire StartupOptionsDlg into the dialog sequence -->
        <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="StartupOptionsDlg" Order="9999" Condition="WIXUI_DONTVALIDATEPATH OR WIXUI_INSTALLDIR_VALID=&quot;1&quot;" />
        
        <!-- StartupOptionsDlg -> VerifyReadyDlg (Next button) -->
        <!-- Add/Remove StartupFeature based on checkbox property existence -->
        <!-- Checkbox Checked -> Property="1" -> AddLocal -->
        <!-- Checkbox Unchecked -> Property=Null -> Remove -->
        <Publish Dialog="StartupOptionsDlg" Control="Next" Event="AddLocal" Value="StartupFeature" Order="1" Condition="LAUNCHONSTARTUP" />
        <Publish Dialog="StartupOptionsDlg" Control="Next" Event="Remove" Value="StartupFeature" Order="2" Condition="NOT LAUNCHONSTARTUP" />
        <Publish Dialog="StartupOptionsDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg" Order="99" />
        
        <!-- StartupOptionsDlg -> InstallDirDlg (Back button) -->
        <Publish Dialog="StartupOptionsDlg" Control="Back" Event="NewDialog" Value="InstallDirDlg" Order="1" />
        
        <!-- VerifyReadyDlg -> StartupOptionsDlg (Back button) -->
        <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="StartupOptionsDlg" Order="9999" Condition="NOT Installed" />
        
        <!-- Launch on finish -->
        <Publish Dialog="ExitDialog" Control="Finish" Property="WixShellExecTarget" Value="[INSTALLFOLDER]\SwitchBlade.exe" Order="1" Condition="WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed" />
        <Publish Dialog="ExitDialog" Control="Finish" Event="DoAction" Value="LaunchApplication" Order="2" Condition="WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed" />
    </UI>

    <!-- Content for Add/Remove Programs -->
    <Icon Id="AppIcon" SourceFile="..\icon.ico"/>
    <Property Id="ARPPRODUCTICON" Value="AppIcon" />

  </Package>

  <Fragment>
      <!-- AppComponents is now populated by HarvestDirectory in the .wixproj -->
  </Fragment>

  <Fragment>
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcut" Guid="*" Bitness="always64">
        <Shortcut Id="ApplicationStartMenuShortcut" 
                  Name="SwitchBlade" 
                  Description="SwitchBlade Window Switcher"
                  Target="[INSTALLFOLDER]SwitchBlade.exe"
                  WorkingDirectory="INSTALLFOLDER" />
        <RemoveFolder Id="CleanUpShortCut" Directory="ApplicationProgramsFolder" On="uninstall" />
        <!-- Use a non-persistent registry flag for the shortcut component's KeyPath -->
        <RegistryValue Root="HKCU" Key="Software\SwitchBlade" Name="shortcut_installed" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <!-- Persistent Registry Component -->
    <Component Id="RegistryPersistence" Directory="INSTALLFOLDER" Guid="c7d8e9f0-1a2b-3c4d-5e6f-7a8b9c0d1e2f" Bitness="always64" Permanent="yes">
       <RegistryKey Root="HKCU" Key="Software\SwitchBlade">
           <RegistryValue Name="installed" Value="1" Type="integer" KeyPath="yes" />
       </RegistryKey>
    </Component>
  </Fragment>

  <!-- Windows Startup Registry Entry -->
  <Fragment>
    <Component Id="StartupRegistryEntry" Directory="INSTALLFOLDER" Guid="b8f4e2d1-5a3c-4b7e-9f12-3c8d5e6a7b9f" Bitness="always64">
      <RegistryValue Root="HKCU" 
                     Key="Software\Microsoft\Windows\CurrentVersion\Run" 
                     Name="SwitchBlade" 
                     Type="string" 
                     Value="&quot;[INSTALLFOLDER]SwitchBlade.exe&quot; /minimized"
                     KeyPath="yes" />
    </Component>
  </Fragment>
</Wix>
