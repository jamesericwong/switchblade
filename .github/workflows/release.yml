name: Release

on:
  release:
    types: [published]

jobs:
  release:
    name: Build Installer & Publish
    runs-on: windows-latest
    environment: Production
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v6

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 9.0.x

    - name: Setup WiX Toolset
      run: |
        dotnet tool install --global wix --version 5.0.2
        wix extension add --global WixToolset.UI.wixext/5.0.2
        wix extension add --global WixToolset.Util.wixext/5.0.2

    - name: Run Tests (Release)
      # Safety check before publishing with coverage collection
      run: dotnet test SwitchBlade.sln -c Release --collect:"XPlat Code Coverage" --settings CodeCoverage.runsettings --results-directory ./coverage

    - name: Code Coverage Report
      uses: danielpalme/ReportGenerator-GitHub-Action@5.3.11
      with:
        reports: coverage/**/coverage.cobertura.xml
        targetdir: coverage
        reporttypes: MarkdownSummaryGithub

    - name: Publish Coverage Summary
      run: cat coverage/SummaryGithub.md >> $GITHUB_STEP_SUMMARY
      shell: bash

    - name: Build Installer (R2R)
      # This builds the Installer project, which triggers the R2R publish of the main app
      # Output: Installer\bin\Release\en-US\SwitchBlade.msi
      run: dotnet build Installer/SwitchBlade.Installer.wixproj -c Release -p:PublishR2R=true

    - name: Upload Installer to Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: Installer/bin/Release/SwitchBlade.msi
