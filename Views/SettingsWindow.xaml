<Window x:Class="SwitchBlade.Views.SettingsWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:core="clr-namespace:SwitchBlade.Core"
        Title="SwitchBlade Settings" Height="650" Width="550"
        ResizeMode="CanResize"
        AllowsTransparency="True"
        WindowStyle="None"
        WindowStartupLocation="CenterScreen"
        PreviewKeyDown="Window_PreviewKeyDown"
        Background="Transparent">
    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibility"/>
        <core:InverseBooleanConverter x:Key="InverseBoolConverter"/>
        
        <Style x:Key="CardStyle" TargetType="Border">
            <Setter Property="Background" Value="#0DFFFFFF"/>
            <Setter Property="CornerRadius" Value="10"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="15"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>

        <Style x:Key="SectionHeaderStyle" TargetType="TextBlock">
            <Setter Property="FontFamily" Value="Inter, Segoe UI, Roboto, sans-serif"/>
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}"/>
            <Setter Property="Margin" Value="0,0,0,12"/>
        </Style>
    </Window.Resources>
    <WindowChrome.WindowChrome>
        <WindowChrome CaptionHeight="30" ResizeBorderThickness="0" GlassFrameThickness="0" CornerRadius="0" />
    </WindowChrome.WindowChrome>

    <Border Background="{DynamicResource WindowBackground}" 
            BorderBrush="{DynamicResource BorderBrush}" 
            BorderThickness="1">
        
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/> <!-- Title Bar -->
                <RowDefinition Height="*"/>    <!-- Content -->
            </Grid.RowDefinitions>

            <!-- Custom Title Bar -->
            <Grid Grid.Row="0" Background="Transparent">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <TextBlock Text="SwitchBlade Settings" 
                           Foreground="{DynamicResource ForegroundBrush}" 
                           VerticalAlignment="Center" 
                           Margin="15,0,0,0" 
                           FontSize="14" 
                           FontWeight="SemiBold"/>
                
                <Button Grid.Column="1" 
                        Content="âœ•" 
                        Width="40" Height="30"
                        Style="{StaticResource ModernButtonStyle}"
                        Background="Transparent"
                        Foreground="{DynamicResource ForegroundBrush}"
                        Click="CloseButton_Click"
                        WindowChrome.IsHitTestVisibleInChrome="True"/>
            </Grid>

            <!-- Main Content -->
            <Grid Grid.Row="1" Margin="20">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                    <StackPanel>
                        <!-- Appearance Section -->
                        <Border Style="{StaticResource CardStyle}">
                            <StackPanel>
                                <TextBlock Text="Appearance" Style="{StaticResource SectionHeaderStyle}"/>
                                <Grid Margin="0,0,0,15">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Theme:" Foreground="{DynamicResource ForegroundBrush}" VerticalAlignment="Center"/>
                                    <ComboBox Grid.Column="1" ItemsSource="{Binding AvailableThemes}" SelectedItem="{Binding SelectedTheme}" HorizontalAlignment="Stretch" Height="30" VerticalContentAlignment="Center"/>
                                </Grid>

                                <Grid Margin="0,0,0,15">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="40"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Window Opacity:" Foreground="{DynamicResource ForegroundBrush}" VerticalAlignment="Center"/>
                                    <Slider Grid.Column="1" Minimum="0.2" Maximum="1.0" Value="{Binding WindowOpacity}" TickFrequency="0.05" IsSnapToTickEnabled="True" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2" Text="{Binding WindowOpacity, StringFormat=P0}" Foreground="{DynamicResource ForegroundBrush}" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                </Grid>

                                <Grid Margin="0,0,0,15">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="40"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Fade Duration (ms):" Foreground="{DynamicResource ForegroundBrush}" VerticalAlignment="Center"/>
                                    <Slider Grid.Column="1" Minimum="0" Maximum="1000" Value="{Binding FadeDurationMs}" TickFrequency="50" IsSnapToTickEnabled="True" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2" Text="{Binding FadeDurationMs}" Foreground="{DynamicResource ForegroundBrush}" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                </Grid>

                                <Grid Margin="0,0,0,15">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="40"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Item Height:" Foreground="{DynamicResource ForegroundBrush}" VerticalAlignment="Center"/>
                                    <Slider Grid.Column="1" Minimum="30" Maximum="100" Value="{Binding ItemHeight}" TickFrequency="5" IsSnapToTickEnabled="True" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2" Text="{Binding ItemHeight}" Foreground="{DynamicResource ForegroundBrush}" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                </Grid>

                                <Grid Margin="0,0,0,15">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Global Hotkey:" Foreground="{DynamicResource ForegroundBrush}" VerticalAlignment="Center"/>
                                    <TextBox x:Name="HotKeyBox" Text="{Binding HotKeyString, Mode=OneWay}" 
                                             Style="{StaticResource ModernTextBoxStyle}"
                                             IsReadOnly="True" 
                                             PreviewKeyDown="HotKeyBox_PreviewKeyDown"
                                             Grid.Column="1" 
                                             Padding="5" 
                                             Cursor="Hand"
                                             ToolTip="Click and press keys to set new hotkey"/>
                                </Grid>

                                <CheckBox Style="{StaticResource ModernCheckBoxStyle}" Content="Enable Window Previews" IsChecked="{Binding EnablePreviews}" Margin="0,5,0,0"/>
                                <CheckBox Style="{StaticResource ModernCheckBoxStyle}" Content="Hide Taskbar Icon" IsChecked="{Binding HideTaskbarIcon}" Margin="0,10,0,0"/>
                                <CheckBox Style="{StaticResource ModernCheckBoxStyle}" Content="Launch on Windows Startup" IsChecked="{Binding LaunchOnStartup}" Margin="0,10,0,0"/>
                                <CheckBox Style="{StaticResource ModernCheckBoxStyle}" Content="Run as Administrator" IsChecked="{Binding RunAsAdministrator}" Margin="0,10,0,0" ToolTip="Some plugins require Administrator privileges for full window inspection"/>
                            </StackPanel>
                        </Border>

                        <!-- Search & Performance Section -->
                        <Border Style="{StaticResource CardStyle}">
                            <StackPanel>
                                <TextBlock Text="Search &amp; Performance" Style="{StaticResource SectionHeaderStyle}"/>
                                
                                <CheckBox Style="{StaticResource ModernCheckBoxStyle}" Content="Enable Number Shortcuts (1-9, 0)" IsChecked="{Binding EnableNumberShortcuts}" Margin="0,0,0,0" ToolTip="Hold modifier + number to quickly switch to a window"/>
                                
                                <Grid Margin="20,10,0,10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Shortcut Modifier:" Foreground="{DynamicResource ForegroundBrush}" VerticalAlignment="Center"/>
                                    <ComboBox ItemsSource="{Binding AvailableShortcutModifiers}" SelectedItem="{Binding SelectedShortcutModifier}" Height="30" VerticalContentAlignment="Center" Grid.Column="1" ToolTip="Hold this key + number to activate window"/>
                                </Grid>

                                <CheckBox Style="{StaticResource ModernCheckBoxStyle}" Content="Enable Badge Animations" IsChecked="{Binding EnableBadgeAnimations}" Margin="0,10,0,0" ToolTip="Staggered fade-in and slide-in animations for Alt+Number badges"/>

                                <Grid Margin="0,15,0,10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="50"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Regex Cache Size:" Foreground="{DynamicResource ForegroundBrush}" VerticalAlignment="Center" ToolTip="Number of compiled search patterns to keep in memory for instant filtering"/>
                                    <Slider Grid.Column="1" Minimum="10" Maximum="500" Value="{Binding RegexCacheSize}" TickFrequency="10" IsSnapToTickEnabled="True" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2" Text="{Binding RegexCacheSize}" Foreground="{DynamicResource ForegroundBrush}" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                </Grid>

                                <TextBlock Text="List Refresh Behavior:" Foreground="{DynamicResource ForegroundBrush}" Margin="0,10,0,5" FontWeight="SemiBold"/>
                                <StackPanel Margin="10,0,0,0">
                                    <RadioButton Style="{StaticResource ModernRadioButtonStyle}" Content="Preserve scroll position (No jump)" IsChecked="{Binding IsPreserveScrollSelected}" Margin="0,0,0,5" ToolTip="Keeps the scroll bar fixed. The selection might change if items move."/>
                                    <RadioButton Style="{StaticResource ModernRadioButtonStyle}" Content="Follow selected window (Identity)" IsChecked="{Binding IsPreserveIdentitySelected}" Margin="0,0,0,5" ToolTip="Keeps the same window selected even if it moves in the list."/>
                                    <RadioButton Style="{StaticResource ModernRadioButtonStyle}" Content="Keep selection index (Position)" IsChecked="{Binding IsPreserveIndexSelected}" Margin="0,0,0,5" ToolTip="Keeps the selection at the same visual row (e.g. 2nd item)."/>
                                </StackPanel>
                            </StackPanel>
                        </Border>

                        <!-- Background Polling Section -->
                        <Border Style="{StaticResource CardStyle}">
                            <StackPanel>
                                <TextBlock Text="Background Polling" Style="{StaticResource SectionHeaderStyle}"/>
                                <CheckBox Style="{StaticResource ModernCheckBoxStyle}" Content="Enable Background Polling" IsChecked="{Binding EnableBackgroundPolling}" Margin="0,0,0,10"/>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="50"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Interval (seconds):" Foreground="{DynamicResource ForegroundBrush}" VerticalAlignment="Center"/>
                                    <Slider Grid.Column="1" Minimum="5" Maximum="120" Value="{Binding BackgroundPollingIntervalSeconds}" TickFrequency="5" IsSnapToTickEnabled="True" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2" Text="{Binding BackgroundPollingIntervalSeconds}" Foreground="{DynamicResource ForegroundBrush}" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <!-- Excluded Processes Section -->
                        <Border Style="{StaticResource CardStyle}">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <TextBlock Grid.Row="0" Text="Excluded Processes" Style="{StaticResource SectionHeaderStyle}"/>

                                <TextBlock Grid.Row="1" Text="Manage process names to hide from results (e.g., SwitchBlade):" 
                                           Foreground="{DynamicResource ForegroundBrush}" TextWrapping="Wrap" Margin="0,0,0,10" Opacity="0.7"/>

                                <ListBox Grid.Row="2" ItemsSource="{Binding ExcludedProcesses}" SelectedItem="{Binding SelectedExcludedProcess}" 
                                         Background="{DynamicResource ControlBackground}" Foreground="{DynamicResource ForegroundBrush}" BorderBrush="{DynamicResource BorderBrush}"
                                         Margin="0,0,0,10" Height="100"/>

                                <Grid Grid.Row="3">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBox Text="{Binding NewExcludedProcessName, UpdateSourceTrigger=PropertyChanged}" 
                                             Style="{StaticResource HighContrastTextBoxStyle}"
                                             Grid.Column="0" Margin="0,0,10,0" Height="30" VerticalContentAlignment="Center"/>
                                    <Button Content="Add" Command="{Binding AddExcludedProcessCommand}" Grid.Column="1" Width="70" Margin="0,0,10,0" Style="{StaticResource ModernButtonStyle}"/>
                                    <Button Content="Remove" Command="{Binding RemoveExcludedProcessCommand}" Grid.Column="2" Width="70" Style="{StaticResource ModernButtonStyle}"/>
                                </Grid>
                            </Grid>
                        </Border>


                        <!-- Loaded Plugins Section -->
                        <Border Style="{StaticResource CardStyle}" Margin="0,0,0,0">
                            <StackPanel>
                                <TextBlock Text="Loaded Plugins" Style="{StaticResource SectionHeaderStyle}"/>
                                <TextBlock Text="Active IWindowProvider modules:" 
                                           Foreground="{DynamicResource ForegroundBrush}" Opacity="0.7" Margin="0,0,0,10"/>
                                
                                <ListView x:Name="PluginsListView" ItemsSource="{Binding LoadedPlugins}" Height="150" 
                                          Background="{DynamicResource ControlBackground}" 
                                          Foreground="{DynamicResource ForegroundBrush}" 
                                          BorderBrush="{DynamicResource BorderBrush}">
                                    <ListView.View>
                                        <GridView>
                                            <GridViewColumn Header="Name" Width="150" DisplayMemberBinding="{Binding Name}"/>
                                            <GridViewColumn Header="Version" Width="60" DisplayMemberBinding="{Binding Version}"/>
                                            <GridViewColumn Header="Enabled" Width="60">
                                                <GridViewColumn.CellTemplate>
                                                    <DataTemplate>
                                                        <CheckBox IsChecked="{Binding IsEnabled}" 
                                                                  HorizontalAlignment="Center" VerticalAlignment="Center"
                                                                  IsEnabled="{Binding IsInternal, Converter={StaticResource InverseBoolConverter}}"
                                                                  Command="{Binding DataContext.TogglePluginCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                                                                  CommandParameter="{Binding}"/>
                                                    </DataTemplate>
                                                </GridViewColumn.CellTemplate>
                                            </GridViewColumn>
                                            <GridViewColumn Header="Settings" Width="70">
                                                <GridViewColumn.CellTemplate>
                                                    <DataTemplate>
                                                        <Button Content="&#xE713;" 
                                                                FontFamily="Segoe MDL2 Assets" FontSize="12"
                                                                Width="30" Height="24"
                                                                Margin="0" Padding="0"
                                                                HorizontalContentAlignment="Center" VerticalContentAlignment="Center"
                                                                Style="{StaticResource ModernButtonStyle}"
                                                                Click="PluginSettingsButton_Click"
                                                                Tag="{Binding}"
                                                                Visibility="{Binding HasSettings, Converter={StaticResource BoolToVisibility}}"
                                                                ToolTip="Open plugin settings"/>
                                                    </DataTemplate>
                                                </GridViewColumn.CellTemplate>
                                            </GridViewColumn>
                                        </GridView>
                                    </ListView.View>
                                </ListView>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Grid>
    </Border>
</Window>
